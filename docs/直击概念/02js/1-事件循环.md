# 事件循环 Event Loop

## 定义

事件循环是`单线程`的 JavaScript 在`处理异步`事件时进行的一种`循环过程`。

## 背景

**JavaScript 是以单线程的方式运行的**

- 同一时刻只能执行特定的任务，而浏览器是多线程的
- JavaScript 为了避免复杂性，而实现单线程执行

**可这样简单理解 JS 的单线程：**

- 从前到后，一行行执行
- 如果某行执行报错，则停止后续代码执行 （同步阻塞）
- 先把同步代码执行完，再执行异步

## 做了什么

Event Loop **解决了 JavaScript 作为单线程语言时的并发性问题**，其执行过程如下：

- 同步代码，放到调用栈，依次执行完
- 期间若有异步代码，标记并放到任务队列等待时机执行
- 无同步代码（调用栈为空），检查任务队列：
  - 如果调用栈为空（同步代码执行完）Event Loop 开始工作
  - 轮询查找调用队列，若有待执行事件则移动到调用栈执行
  - 只要有空闲就不断轮询查找
- 重复以上步骤形成事件循环

![Evnet Loop简单流程图](../../public/02js/eventloop.jpg)

这只是把事件循环这个概念说了，很多重点还没浮出水面。答到这，面试官肯定不会满意，所以你还需要了解以下概念，顶住下一轮深挖。

## 需要了解的几个概念

### 主线程 Main thread

`所有的同步任务都是在主线程里执行的。`主线程用于浏览器处理用户事件和页面绘制等。默认情况下，浏览器在一个线程中运行一个页面中的所有 JavaScript 脚本，以及呈现布局，回流，和垃圾回收。

- 同步任务： 指在主线程上排队等待执行的任务，只有前一个任务执行完毕，才能执行后一个任务
- 异步任务： 只有引擎认为某个异步任务可以执行了，该任务（采用回调函数的形式）才会进入主线程执行

### 宏任务 macro task

指的是浏览器在执行代码的过程中会调度的任务，比如事件循环中的每一次迭代、setTimeout 和 setInterval 等。 宏任务会在浏览器完成当前同步任务之后执行。

**这些都属于宏任务：**

- script (待执行脚本)
- setTimeout
- setInterval
- setImmediate
- I/O
- UI render

### 微任务 microtask

本质就是一个待调用的 function，当创建该微任务的函数执行之后，并且只有当 Javascript 调用栈为空，而控制权尚未返还给被用户代理用来驱动脚本执行环境的事件循环之前，该微任务才会被执行。

**这些都属于微任务：**

- Promise
- async / await
- process.nextTick (Node)
- mutationObserver( html5 API)

## 展开来说 - 事件循环过程

事件循环是单线程的 JavaScript 在处理异步事件时进行的一种循环过程，具体来讲，对于异步事件它会先加入到事件队列中挂起，等主线程空闲时会去执行事件队列中的事件。

> 在同一轮任务队列中，同一个微任务产生的微任务会放在这一轮微任务的后面，产生的宏任务会放在这一轮的宏任务后面。
> 在同一轮任务队列中，同一个宏任务产生的微任务会马上执行，产生的宏任务会放在这一轮的宏任务后面

`主线程任务——>微任务——>宏任务` 如果宏任务里还有微任就继续执行宏任务里的微任务，如果宏任务中的微任务中还有宏任务就在依次进行

`主线程任务——>微任务——>宏任务——>宏任务里的微任务——>宏任务里的微任务中的宏任务——>直到任务全部完成`

它不停检查 Call Stack 中是否有任务（也叫栈帧）需要执行，如果没有，就检查 Event Queue，从中弹出一个任务，放入 Call Stack 中，如此往复循环。

![事件循环流程函数版](../../public/02js/eventloop2.jpg)

## 其他

### 为什么先微后宏

微任务会在执行任何其他事件处理，或渲染，或执行任何其他宏任务之前完成。

这很重要，因为它确保了微任务之间的应用程序环境基本相同（没有鼠标坐标更改，没有新的网络数据等）。

如果我们想要异步执行（在当前代码之后）一个函数，但是要在更改被渲染或新事件被处理之前执行，那么我们可以使用 `queueMicrotask` 来对其进行安排（schedule）

### Node.js 和 浏览器 eventLoop 的区别

两者最主要的区别在于：

- 浏览器中的微任务是在每个相应的宏任务中执行的
- Node.js 中的微任务是在不同阶段之间执行的



## 参考资料

- [关于 JavaScript 单线程的一些事](https://github.com/JChehe/blog/blob/master/posts/%E5%85%B3%E4%BA%8EJavaScript%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BA%8B.md)
- [一看就懂的事件循环机制(event loop)](https://juejin.cn/post/7002037475874963493)
